<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protektor & Obfuscator File (Client-Side) - v4.0 Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e0e0e0;
            --primary-color: #0f3460;
            --button-hover: #1f4068;
            --border-color: #0f3460;
            --textarea-bg: #0d1627;
            --placeholder-color: #a0a0a0;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #28a745;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 900px; /* Lebih lebar untuk opsi obfuscation */
            animation: fadeIn 0.8s ease-out;
            margin-top: 50px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #6a0572, #8e2d2d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            color: var(--text-color);
        }

        input[type="file"], input[type="text"], input[type="date"], input[type="number"], select {
            display: block;
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--textarea-bg);
            color: var(--text-color);
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        input[type="file"]::file-selector-button {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 15px;
            transition: background-color 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: var(--button-hover);
        }

        input[type="file"]:focus, input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.5);
        }

        select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px; /* Make space for the arrow */
        }

        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--textarea-bg);
            color: var(--text-color);
            font-size: 1rem;
            min-height: 150px;
            resize: vertical;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        textarea::placeholder {
            color: var(--placeholder-color);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.5);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            min-width: 120px;
        }

        .btn:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background-color: #3f5b82;
            cursor: not-allowed;
            transform: none;
        }

        .btn-reset {
            background-color: #d9534f;
        }

        .btn-reset:hover {
            background-color: #c9302c;
        }

        .file-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--placeholder-color);
        }

        .file-info strong {
            color: var(--text-color);
        }

        .hidden {
            display: none !important;
        }

        .message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.95em;
            font-weight: 500;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .message.warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .message.success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
            flex-direction: column;
            gap: 15px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s ease-in-out;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        .expiration-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .expiration-options div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .obfuscation-options {
            margin-top: 30px;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            background-color: rgba(15, 52, 96, 0.1);
        }

        .obfuscation-options h3 {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .obfuscation-option-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .obfuscation-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            background-color: var(--textarea-bg);
            border: 1px solid var(--border-color);
        }

        .obfuscation-option label {
            margin-bottom: 0;
            flex-grow: 1;
            cursor: pointer;
        }

        .obfuscation-option input[type="checkbox"], .obfuscation-option input[type="number"], .obfuscation-option select {
            margin: 0;
            width: auto;
            min-width: 50px;
        }
        
        .obfuscation-option input[type="number"] {
            width: 80px;
        }


        /* Responsif untuk HP */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 20px;
                margin-top: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                flex-basis: 100%;
            }

            .button-group {
                flex-direction: column;
            }
            .expiration-options div {
                flex-direction: column;
                align-items: flex-start;
            }
            .expiration-options input, .expiration-options select {
                width: 100%;
            }
            .obfuscation-option-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/javascript-obfuscator@2.20.0/dist/javascript-obfuscator.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Protektor & Obfuscator File (Client-Side) - v4.0 Pro</h1>

        <div class="form-group">
            <label for="licenseKeyInput">License Key (akan menjadi kunci proteksi):</label>
            <input type="text" id="licenseKeyInput" placeholder="Masukkan license key yang Anda inginkan (misal: MY-CUSTOM-KEY)">
            <div id="licenseError" class="message error hidden"></div>
        </div>

        <div class="form-group">
            <label>Pengaturan Tanggal Kedaluwarsa:</label>
            <div class="expiration-options">
                <div>
                    <input type="radio" id="expireSpecificDate" name="expireType" value="specific" checked>
                    <label for="expireSpecificDate">Tanggal Spesifik:</label>
                    <input type="date" id="specificDateInput">
                </div>
                <div>
                    <input type="radio" id="expireRelative" name="expireType" value="relative">
                    <label for="expireRelative">Dari Sekarang:</label>
                    <input type="number" id="relativeDurationInput" value="1" min="1" style="width: 80px;">
                    <select id="relativeUnitSelect">
                        <option value="hours">Jam</option>
                        <option value="days" selected>Hari</option>
                        <option value="months">Bulan</option>
                    </select>
                </div>
                <div>
                    <input type="radio" id="expireNever" name="expireType" value="never">
                    <label for="expireNever">Tidak Akan Kedaluwarsa (Selamanya)</label>
                </div>
            </div>
            <div id="expireDateDisplay" class="message success hidden"></div>
        </div>

        <div class="form-group">
            <label for="fileInput">Pilih File (Semua Tipe):</label>
            <input type="file" id="fileInput">
            <div id="fileInfo" class="file-info hidden">
                Nama File: <strong id="fileName"></strong> | Ukuran: <strong id="fileSize"></strong>
            </div>
            <div id="fileContentDisplay" class="message hidden"></div>
        </div>

        <div class="obfuscation-options">
            <h3>Opsi Obfuscation (Khusus JavaScript)</h3>
            <div class="obfuscation-option-group">
                <div class="obfuscation-option">
                    <input type="checkbox" id="compactCode" checked>
                    <label for="compactCode">Compact Code (Baris Tunggal)</label>
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="controlFlowFlattening" checked>
                    <label for="controlFlowFlattening">Control Flow Flattening</label>
                </div>
                <div class="obfuscation-option">
                    <label for="controlFlowFlatteningProb">Probabilitas Flow Flattening:</label>
                    <input type="number" id="controlFlowFlatteningProb" min="0" max="1" step="0.1" value="0.7">
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="stringArray" checked>
                    <label for="stringArray">Sembunyikan String (String Array)</label>
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="stringArrayRotate" checked>
                    <label for="stringArrayRotate">String Array Rotate</label>
                </div>
                <div class="obfuscation-option">
                    <label for="stringArrayEncoding">String Array Encoding:</label>
                    <select id="stringArrayEncoding">
                        <option value="base64">Base64</option>
                        <option value="rc4">RC4</option>
                        <option value="none" selected>None</option>
                    </select>
                </div>
                 <div class="obfuscation-option">
                    <input type="checkbox" id="deadCodeInjection">
                    <label for="deadCodeInjection">Dead Code Injection</label>
                </div>
                <div class="obfuscation-option">
                    <label for="deadCodeInjectionProb">Probabilitas Dead Code:</label>
                    <input type="number" id="deadCodeInjectionProb" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="identifierNamesGenerator" checked>
                    <label for="identifierNamesGenerator">Ganti Nama Identifier</label>
                </div>
                <div class="obfuscation-option">
                    <label for="unicodeEscapeSequence">Unicode Escape Sequences:</label>
                    <select id="unicodeEscapeSequence">
                        <option value="true">True</option>
                        <option value="false" selected>False</option>
                    </select>
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="disableConsoleOutput" checked>
                    <label for="disableConsoleOutput">Disable Console Output</label>
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="splitStrings">
                    <label for="splitStrings">Split Strings</label>
                </div>
                 <div class="obfuscation-option">
                    <label for="transformObjectKeys">Transform Object Keys:</label>
                    <select id="transformObjectKeys">
                        <option value="true">True</option>
                        <option value="false" selected>False</option>
                    </select>
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="renameGlobals" checked>
                    <label for="renameGlobals">Rename Globals</label>
                </div>
                <div class="obfuscation-option">
                    <input type="checkbox" id="selfDefending" checked>
                    <label for="selfDefending">Self Defending</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="originalContentArea">Isi File Asli:</label>
            <textarea id="originalContentArea" placeholder="Isi file yang di-upload atau paste di sini..." readonly></textarea>
        </div>

        <div class="form-group">
            <label for="encodedOutput">Hasil Encode & Obfuscate (Marvel Words):</label>
            <textarea id="encodedOutput" placeholder="Hasil encoding dan obfuscation akan muncul di sini..." readonly></textarea>
        </div>
        
        <div class="button-group">
            <button class="btn" id="encodeButton" disabled>Encode & Proteksi File</button>
            <button class="btn" id="obfuscateJsButton" disabled>Obfuscate JS Saja</button>
            <button class="btn" id="copyOutputButton" disabled>Salin Hasil (Marvel Words)</button>
            <button class="btn" id="generateScriptButton" disabled>Generate Python Validator & Encrypted Data</button>
            <button class="btn btn-reset" id="resetButton">Reset</button>
        </div>
        <div id="executionWarningMessage" class="message warning hidden"></div>
        <div id="obfuscationWarningMessage" class="message warning hidden"></div>
        <div id="infoMessage" class="message success hidden"></div> </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loader"></div>
        <p>Sedang memproses, harap tunggu...</p>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const licenseKeyInput = document.getElementById('licenseKeyInput');
        const licenseErrorDiv = document.getElementById('licenseError');
        const fileInput = document.getElementById('fileInput');
        const fileNameSpan = document.getElementById('fileName');
        const fileSizeSpan = document.getElementById('fileSize');
        const fileInfoDiv = document.getElementById('fileInfo');
        const originalContentArea = document.getElementById('originalContentArea');
        const encodedOutput = document.getElementById('encodedOutput');
        const encodeButton = document.getElementById('encodeButton');
        const obfuscateJsButton = document.getElementById('obfuscateJsButton'); // New button
        const copyOutputButton = document.getElementById('copyOutputButton');
        const generateScriptButton = document.getElementById('generateScriptButton');
        const resetButton = document.getElementById('resetButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toast = document.getElementById('toast');
        const fileContentDisplay = document.getElementById('fileContentDisplay');
        const executionWarningMessage = document.getElementById('executionWarningMessage');
        const obfuscationWarningMessage = document.getElementById('obfuscationWarningMessage'); // New warning for JS only
        const infoMessage = document.getElementById('infoMessage'); // New element

        // Expire Date Elements
        const expireSpecificDateRadio = document.getElementById('expireSpecificDate');
        const specificDateInput = document.getElementById('specificDateInput');
        const expireRelativeRadio = document.getElementById('expireRelative');
        const relativeDurationInput = document.getElementById('relativeDurationInput');
        const relativeUnitSelect = document.getElementById('relativeUnitSelect');
        const expireNeverRadio = document.getElementById('expireNever');
        const expireDateDisplay = document.getElementById('expireDateDisplay');

        // Obfuscation Options Elements
        const compactCode = document.getElementById('compactCode');
        const controlFlowFlattening = document.getElementById('controlFlowFlattening');
        const controlFlowFlatteningProb = document.getElementById('controlFlowFlatteningProb');
        const stringArray = document.getElementById('stringArray');
        const stringArrayRotate = document.getElementById('stringArrayRotate');
        const stringArrayEncoding = document.getElementById('stringArrayEncoding');
        const deadCodeInjection = document.getElementById('deadCodeInjection');
        const deadCodeInjectionProb = document.getElementById('deadCodeInjectionProb');
        const identifierNamesGenerator = document.getElementById('identifierNamesGenerator');
        const unicodeEscapeSequence = document.getElementById('unicodeEscapeSequence');
        const disableConsoleOutput = document.getElementById('disableConsoleOutput');
        const splitStrings = document.getElementById('splitStrings');
        const transformObjectKeys = document.getElementById('transformObjectKeys');
        const renameGlobals = document.getElementById('renameGlobals');
        const selfDefending = document.getElementById('selfDefending');


        // --- KONFIGURASI PROTEKSI ---
        const INITIAL_ALLOWED_DEVICE_ID_PLACEHOLDER = "YOUR_DEVICE_ID_WILL_BE_SET_HERE_BY_PYTHON_SCRIPT";
        
        // --- MAPPING BASE64 KE KATA MARVEL (KONSISTEN) ---
        const BASE64_CHARS_ORIGINAL = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        const marvelWordsOriginal = [
            "marvel", "ganteng", "banget", "thor", "loki", "wanda", "vision",
            "hulk", "ultron", "wakanda", "hydra", "ironman", "venom", "strange",
            "groot", "rocket", "mjolnir", "thanos", "antman", "panther", "bucky", "shuri",
            "nebula", "gamora", "drax", "mantis", "spiderman", "drdoom", "galactus", "silver",
            "surfer", "deadpool", "cable", "domino", "xmen", "avengers", "fantastic", "four",
            "blade", "ghost", "rider", "daredevil", "elektra", "punisher", "blackpanther",
            "captainamerica", "ironfist", "lukecage", "jessicajones", "eternals", "nova",
            "scarletwitch", "quicksilver", "hawkeye", "blackwidow", "falcon", "warmachine",
            "korg", "meek", "valkyrie", "okoye", "killmonger", "mandarin", "dormammu", "enchantress",
            "hela", "redskull", "baronzemo", "ronan", "skrulls", "kree", "celestials", "infinity",
            "gauntlet", "stones", "tesseract", "aether", "orb", "scepter", "soulstone", "powerstone"
        ];
        if (marvelWordsOriginal.length < BASE64_CHARS_ORIGINAL.length) {
            console.error("Error: Jumlah marvelWords tidak cukup untuk semua karakter Base64!");
            alert("Error konfigurasi: Tambahkan lebih banyak kata Marvel di kode!");
        }

        // --- Seed untuk Random Shuffling (PENTING: harus sama di JS dan Python) ---
        const SHUFFLE_SEED = 1337; 

        let currentFileName = '';
        let currentFileExtension = ''; 
        let originalFileChecksum = '';
        let currentEncodedMarvelString = ''; 

        // --- UTILITY FUNCTIONS ---
        function showToast(message, type = 'info') {
            toast.textContent = message;
            const rootStyles = getComputedStyle(document.documentElement);
            let bgColor;
            if (type === 'success') bgColor = rootStyles.getPropertyValue('--success-color');
            else if (type === 'error') bgColor = rootStyles.getPropertyValue('--error-color');
            else if (type === 'warning') bgColor = rootStyles.getPropertyValue('--warning-color');
            else bgColor = '#333'; 

            toast.style.backgroundColor = bgColor;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type} show`;
        }

        function hideMessage(element) {
            element.classList.remove('show');
            element.textContent = '';
        }

        function showLoading(message = "Sedang memproses...") {
            loadingOverlay.querySelector('p').textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return hash.toString();
        }

        // --- ZLIB Compression/Decompression (menggunakan Pako.js) ---
        function compressContent(content) {
            const binaryString = new TextEncoder().encode(content);
            const compressed = pako.deflate(binaryString, { level: 9 });
            return btoa(String.fromCharCode.apply(null, compressed));
        }
        
        // --- RANDOM SHUFFLE FUNCTION (untuk memastikan konsistensi seed antara JS dan Python) ---
        let _currentSeed = SHUFFLE_SEED;
        function getNextPseudoRandom() {
            _currentSeed = (_currentSeed * 9301 + 49297) % 233280;
            return _currentSeed / 233280;
        }

        function seededShuffle(array) {
            _currentSeed = SHUFFLE_SEED; 
            let currentIndex = array.length, randomIndex;

            while (currentIndex !== 0) {
                randomIndex = Math.floor(getNextPseudoRandom() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- ENCODING LOGIC (SUDAH DISINKRONKAN dengan Zlib) ---
        function encodeFileContent(content) {
            if (!content) return ''; 

            // Menggunakan encodeURIComponent untuk menangani karakter non-ASCII dengan benar
            const base64Encoded = btoa(unescape(encodeURIComponent(content)));
            const zlibCompressedBase64 = compressContent(base64Encoded);

            let encodedWords = [];
            for (let i = 0; i < zlibCompressedBase64.length; i++) {
                const char = zlibCompressedBase64[i];
                const index = BASE64_CHARS_ORIGINAL.indexOf(char);
                if (index === -1) {
                    console.error(`Karakter Base64 (setelah Zlib) tidak ditemukan di BASE64_CHARS_ORIGINAL: ${char}`);
                    throw new Error(`Karakter Base64 (setelah Zlib) tidak valid '${char}' pada indeks ${i}.`);
                } else {
                    encodedWords.push(marvelWordsOriginal[index]);
                }
            }
            return encodedWords.join(' ');
        }

        // --- FUNGSI BARU: HITUNG TANGGAL KEDALUWARSA ---
        function calculateExpiryDate() {
            let expiryDate = null;
            if (expireSpecificDateRadio.checked) {
                if (specificDateInput.value) {
                    expiryDate = new Date(specificDateInput.value);
                    // Set time to end of day for specific date, for consistency
                    expiryDate.setHours(23, 59, 59, 999); 
                }
            } else if (expireRelativeRadio.checked) {
                const duration = parseInt(relativeDurationInput.value);
                const unit = relativeUnitSelect.value;
                if (!isNaN(duration) && duration > 0) {
                    expiryDate = new Date(); 
                    if (unit === 'hours') {
                        expiryDate.setHours(expiryDate.getHours() + duration);
                    } else if (unit === 'days') {
                        expiryDate.setDate(expiryDate.getDate() + duration);
                        expiryDate.setHours(23, 59, 59, 999); 
                    } else if (unit === 'months') {
                        expiryDate.setMonth(expiryDate.getMonth() + duration);
                        expiryDate.setHours(23, 59, 59, 999); 
                    }
                }
            } else if (expireNeverRadio.checked) {
                expiryDate = new Date("9999-12-31T23:59:59"); 
            }

            if (expiryDate) {
                return expiryDate.toISOString().slice(0, 19); 
            }
            return null; 
        }

        function updateExpiryDisplay() {
            const calculatedDate = calculateExpiryDate();
            if (expireNeverRadio.checked) {
                showMessage(expireDateDisplay, "Mode: Tidak akan kedaluwarsa (Selamanya)", "success");
            } else if (calculatedDate) {
                showMessage(expireDateDisplay, `Tanggal kedaluwarsa yang dihitung: ${new Date(calculatedDate).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'medium' })} WIB`, "success");
            } else {
                hideMessage(expireDateDisplay);
            }
        }

        // --- PROTECTION LOGIC (Hanya untuk cek di sisi browser, tidak relevan untuk auto-registrasi di Python) ---
        function checkProtectionStatus(licenseKey, uploadedContentChecksum, actualExpireDateStr) {
            const today = new Date();
            const errors = [];
            let isValid = true;
            let currentFileContent = originalContentArea.value; 
            let currentFileChecksum = simpleHash(currentFileContent);

            if (!licenseKey) { 
                errors.push("License Key harus diisi, Bro!");
                isValid = false;
            }

            if (expireNeverRadio.checked) {
                // No date check in browser if set to never expire
            } else {
                const EXPIRED_DATE_OBJ_CHECK = new Date(actualExpireDateStr);
                if (today > EXPIRED_DATE_OBJ_CHECK) { 
                    errors.push("Waduh, masa berlaku license sudah expired, bre! Tanggal sekarang: " + today.toLocaleDateString() + ", Expired: " + EXPIRED_DATE_OBJ_CHECK.toLocaleDateString());
                    isValid = false;
                }
            }
            
            if (uploadedContentChecksum && uploadedContentChecksum !== currentFileChecksum) {
                errors.push("DETECTED: File telah dimodifikasi! Checksum tidak cocok, bre! Ini peringatan keras!");
            }

            return { isValid, errors };
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateButtonStates() {
            const hasOriginalContent = originalContentArea.value.trim() !== '';
            const hasEncodedOutput = encodedOutput.value.trim() !== ''; 
            const isLicenseKeyProvided = licenseKeyInput.value.trim() !== ''; 

            encodeButton.disabled = !(hasOriginalContent && isLicenseKeyProvided);
            obfuscateJsButton.disabled = !(hasOriginalContent && currentFileExtension === '.js'); // Only enable for .js
            copyOutputButton.disabled = !hasEncodedOutput;
            // saveOutputButton.disabled = !hasEncodedOutput; // saveOutputButton will be removed/changed
            generateScriptButton.disabled = !hasEncodedOutput;

            specificDateInput.disabled = !expireSpecificDateRadio.checked;
            relativeDurationInput.disabled = !expireRelativeRadio.checked;
            relativeUnitSelect.disabled = !expireRelativeRadio.checked;
            
            updateExpiryDisplay();

            // Updated warning message for execution
            if (currentFileExtension && !['.py', '.js', '.json'].includes(currentFileExtension)) {
                 showMessage(executionWarningMessage, `Perhatian: File ini awalnya tipe '${currentFileExtension}'. Script proteksi yang dihasilkan akan dalam format Python. Untuk mendekode dan menggunakan kontennya, Anda perlu menambahkan logika penanganan khusus di dalam script Python hasil generate.`, "warning");
            } else if (currentFileExtension === '.js') {
                 showMessage(executionWarningMessage, `Perhatian: Anda akan meng-generate file Python validator dan file .js yang terenkripsi. Anda perlu memanggil validator Python dari script Node.js atau aplikasi JS Anda.`, "warning");
            } else if (currentFileExtension === '.json') {
                 showMessage(executionWarningMessage, `Perhatian: Anda akan meng-generate file Python validator dan file .json yang terenkripsi. Anda perlu memanggil validator Python dari aplikasi Anda untuk mendapatkan data JSON yang didekode.`, "warning");
            }
            else {
                hideMessage(executionWarningMessage);
            }

            // Show/hide obfuscation warning
            if (obfuscateJsButton.disabled && currentFileExtension !== '.js' && hasOriginalContent) {
                showMessage(obfuscationWarningMessage, `Fitur "Obfuscate JS Saja" hanya berfungsi untuk file berekstensi '.js'.`, "warning");
            } else {
                hideMessage(obfuscationWarningMessage);
            }

            // New info message
            if (hasEncodedOutput && currentEncodedMarvelString) {
                showMessage(infoMessage, "Sekarang, klik 'Generate Python Validator & Encrypted Data' untuk mendapatkan file yang siap pakai. Baca petunjuk penggunaannya!", "info");
            } else {
                hideMessage(infoMessage);
            }
        }

        // --- FUNGSI UTAMA: GENERATE PYTHON SCRIPT UNTUK SELF-DECODE DAN SELF-REGISTER DEVICE ID ---
        // Kali ini, script Python tidak lagi mengandung konten asli,
        // melainkan akan membaca file terpisah yang berisi data terenkripsi.
        function generatePythonValidatorScript(customLicenseKey, finalExpireDateStr) {
            let charWordPairs = [];
            for (let i = 0; i < BASE64_CHARS_ORIGINAL.length; i++) {
                charWordPairs.push([BASE64_CHARS_ORIGINAL[i], marvelWordsOriginal[i]]);
            }

            const shuffledPairs = seededShuffle([...charWordPairs]); 
            const shuffledBase64Chars = shuffledPairs.map(pair => pair[0]);
            const shuffledMarvelWords = shuffledPairs.map(pair => pair[1]);

            const pythonShuffledBase64Chars = `[${shuffledBase64Chars.map(s => `'${s}'`).join(', ')}]`;
            const pythonShuffledMarvelWords = `[${shuffledMarvelWords.map(s => `'${s}'`).join(', ')}]`;
            
            const deviceIdPlaceholder = INITIAL_ALLOWED_DEVICE_ID_PLACEHOLDER;

            const expiredDateConfigPython = expireNeverRadio.checked ?
                                            `EXPIRED_DATE_STR = "NEVER_EXPIRE"` :
                                            `EXPIRED_DATE_STR = "${finalExpireDateStr}"`;

            // Nama file data terenkripsi akan diambil dari argumen command line
            const pythonScript = 
                '"""\n' +
                'Ini adalah Python Validator untuk file terproteksi (Marvel Edition v4.0 Pro).\n' +
                `Dibuat pada ${new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })} WIB.\n` +
                'Script ini bertanggung jawab untuk memvalidasi License Key, HWID, Expire Date,\n' +
                'dan mendekode konten terenkripsi dari file eksternal.\n' +
                '"""\n' +
                '\n' +
                'import base64\n' +
                'import sys\n' +
                'import datetime\n' +
                'import platform\n' +
                'import socket\n' +
                'import os\n' +
                'import re\n' +
                'import traceback \n' +
                'import zlib \n' +
                'import random \n' + 
                '\n' +
                '# --- KONFIGURASI PROTEKSI ---\n' +
                `VALID_LICENSE_KEY = "${customLicenseKey}" \n` +
                `${expiredDateConfigPython}\n` + 
                `ALLOWED_DEVICE_ID = "${deviceIdPlaceholder}" \n` +
                '\n' +
                '# --- Data untuk Merekonstruksi Tabel Dekode ---\n' +
                `_SHUFFLED_BASE64_CHARS = ${pythonShuffledBase64Chars}\n` +
                `_SHUFFLED_MARVEL_WORDS = ${pythonShuffledMarvelWords}\n` +
                `_SHUFFLE_SEED = ${SHUFFLE_SEED} \n` +
                '\n' +
                '# --- FUNGSI UTILITY INTERNAL ---\n' +
                'def get_current_device_id_python():\n' +
                '    """Mengambil informasi unik dari device saat ini."""\n' +
                '    parts = []\n' +
                '    try:\n' +
                '        parts.append(f"OS:{platform.system()}")\n' +
                '        parts.append(f"Node:{socket.gethostname()}") \n' +
                '        parts.append(f"Machine:{platform.machine()}") \n' +
                '        parts.append(f"Processor:{platform.processor()}") \n' +
                '    except Exception as e:\n' +
                '        parts.append(f"ErrorGettingDeviceID:{e}")\n' +
                '    return "|".join(parts)\n' +
                '\n' +
                'def update_script_with_device_id(script_path, new_device_id, placeholder):\n' +
                '    """\n' +
                '    Menulis ulang file script untuk memasukkan Device ID yang baru ditemukan.\n' +
                '    """\n' +
                '    try:\n' +
                '        with open(script_path, \'r\', encoding=\'utf-8\') as f:\n' +
                '            content = f.read()\n' +
                '        \n' +
                `        search_pattern_str = 'ALLOWED_DEVICE_ID = \\"' + placeholder + '\\"'\n` +
                `        escaped_search_pattern = re.escape(search_pattern_str)\n` +
                `        pattern = re.compile(escaped_search_pattern)\n` +
                '\n' +
                '        if pattern.search(content):\n' +
                `            new_content = pattern.sub('ALLOWED_DEVICE_ID = \\"' + new_device_id + '\\"', content);\n` +
                '            \n' +
                '            with open(script_path, \'w\', encoding=\'utf-8\') as f:\n' +
                '                f.write(new_content)\n' +
                '            # print("INFO: Device ID berhasil direkam dan disimpan ke script untuk proteksi.")\n' +
                '            return True\n' +
                '        else:\n' +
                '            print("WARNING: Placeholder Device ID tidak ditemukan di script. File mungkin sudah dimodifikasi atau rusak.")\n' +
                '            return False\n' +
                '    except Exception as e:\n' +
                '        print(f"ERROR: Gagal menyimpan Device ID ke script: {e}")\n' +
                '        print("Pastikan script memiliki izin tulis di lokasinya.")\n' +
                '        # print(f"Detail error: {e}")\n' +
                '        return False\n' +
                '\n' +
                'def check_protection_python(user_license_key, current_script_path, device_id_placeholder_from_js):\n' +
                '    current_device = get_current_device_id_python()\n' +
                '    \n' +
                '    global ALLOWED_DEVICE_ID \n' +
                '    \n' +
                '    if ALLOWED_DEVICE_ID == device_id_placeholder_from_js:\n' +
                '        # print("\\n=======================================================")\n' +
                '        # print("          *** PROSES REGISTRASI DEVICE ***")\n' +
                '        # print("=======================================================")\n' +
                '        # print("Ini adalah pertama kali script dijalankan di device ini.")\n' +
                '        # print(f"DEVICE ID YANG AKAN DIREKAM: >>> {current_device} <<<")\n' +
                '        # print("Merekam Device ID ini untuk proteksi di masa depan...")\n' +
                '        \n' +
                '        if update_script_with_device_id(current_script_path, current_device, device_id_placeholder_from_js):\n' +
                '            ALLOWED_DEVICE_ID = current_device\n' +
                '            # print("Registrasi Device ID berhasil! Script akan melanjutkan eksekusi.")\n' +
                '        else:\n' +
                '            # print("\\nERROR: Gagal melakukan registrasi device otomatis. Script tidak dapat dilanjutkan.")\n' +
                '            return False \n' +
                '    \n' +
                '    today = datetime.datetime.now()\n' +
                '\n' +
                '    errors = []\n' +
                '\n' +
                '    if user_license_key != VALID_LICENSE_KEY: \n' +
                '        errors.append("License Key salah.")\n' +
                '\n' +
                '    if EXPIRED_DATE_STR != "NEVER_EXPIRE":\n' +
                '        try:\n' +
                '            expired_date = datetime.datetime.fromisoformat(EXPIRED_DATE_STR)\n' +
                '            if today > expired_date:\n' +
                '                errors.append(f"Masa berlaku license sudah expired.")\n' +
                '        except ValueError:\n' +
                '            errors.append("Format tanggal kedaluwarsa tidak valid.")\n' +
                '\n' +
                '    if current_device != ALLOWED_DEVICE_ID:\n' +
                '        errors.append(f"Device tidak dikenali atau tidak diizinkan.")\n' +
                '    \n' +
                '    if errors:\n' +
                '        # print("\\n--- Proteksi Gagal ---")\n' +
                '        for error in errors:\n' +
                '            print(f"ERROR_PROTECTION: {error}", file=sys.stderr)\n' +
                '        # print("----------------------")\n' +
                '        return False\n' +
                '    return True\n' +
                '\n' +
                'def reconstruct_decode_table():\n' +
                '    """Merekonstruksi DECODE_TABLE dari data yang diacak."""\n' +
                '    random.seed(_SHUFFLE_SEED) \n' +
                '    decode_table = {word: char for char, word in zip(_SHUFFLED_BASE64_CHARS, _SHUFFLED_MARVEL_WORDS)}\n' +
                '    return decode_table\n' +
                '\n' +
                'def decode_marvel_string_from_list(marvel_word_list, decode_table_ref):\n' +
                '    base64_chars = []\n' +
                '    for word in marvel_word_list:\n' +
                '        if not word: \n' +
                '            continue\n' +
                '        if word in decode_table_ref: \n' +
                '            base64_chars.append(decode_table_ref[word])\n' +
                '        else:\n' +
                '            print(f"ERROR_DECODE: Kata \'{word}\' tidak ditemukan di tabel dekode!", file=sys.stderr)\n' +
                '            return None \n' +
                '    \n' +
                '    zlib_compressed_base64_str = "".join(base64_chars)\n' +
                '\n' +
                '    try:\n' +
                '        compressed_bytes = base64.b64decode(zlib_compressed_base64_str)\n' +
                '        decompressed_bytes = zlib.decompress(compressed_bytes)\n' +
                '        \n' +
                '        base64_str_from_zlib = decompressed_bytes.decode(\'utf-8\')\n' +
                '\n' +
                '        decoded_original_bytes = base64.b64decode(base64_str_from_zlib)\n' +
                '        original_content = decoded_original_bytes.decode(\'utf-8\')\n' +
                '        \n' +
                '        return original_content\n' +
                '\n' +
                '    except zlib.error as e:\n' +
                '        print(f"ERROR_DECODE: Gagal dekompresi Zlib: {e}", file=sys.stderr)\n' +
                '        return None\n' +
                '    except base64.binascii.Error as e:\n' +
                '        print(f"ERROR_DECODE: Gagal Base64 decode: {e}", file=sys.stderr)\n' +
                '        return None\n' +
                '    except Exception as e:\n' +
                '        print(f"ERROR_DECODE: Kesalahan tidak terduga: {e}", file=sys.stderr)\n' +
                '        # traceback.print_exc(file=sys.stderr)\n' +
                '        return None\n' +
                '\n' +
                '\n' +
                'def main():\n' +
                '    if len(sys.argv) < 3:\n' +
                '        print("Usage: python validator.py <license_key> <path_to_encrypted_file>", file=sys.stderr)\n' +
                '        sys.exit(1)\n' +
                '\n' +
                '    user_license_key = sys.argv[1]\n' +
                '    encrypted_file_path = sys.argv[2]\n' +
                '    current_script_path = os.path.abspath(sys.argv[0])\n' +
                '\n' +
                `    if not check_protection_python(user_license_key, current_script_path, "${INITIAL_ALLOWED_DEVICE_ID_PLACEHOLDER}"):\n` +
                '        sys.exit(1)\n' +
                '\n' +
                '    try:\n' +
                '        with open(encrypted_file_path, \'r\', encoding=\'utf-8\') as f:\n' +
                '            encrypted_marvel_string = f.read().strip()\n' +
                '\n' +
                '        _ENCODED_MARVEL_WORD_LIST = encrypted_marvel_string.split(\' \')\n' +
                '\n' +
                '        DECODE_TABLE_RECONSTRUCTED = reconstruct_decode_table()\n' +
                '        if DECODE_TABLE_RECONSTRUCTED is None:\n' +
                '            print("ERROR_DECODE: Gagal merekonstruksi tabel dekode.", file=sys.stderr)\n' +
                '            sys.exit(1)\n' +
                '\n' +
                '        original_content = decode_marvel_string_from_list(_ENCODED_MARVEL_WORD_LIST, DECODE_TABLE_RECONSTRUCTED)\n' +
                '        if original_content is None:\n' + 
                '            print("ERROR_DECODE: Dekode gagal.", file=sys.stderr)\n' +
                '            sys.exit(1)\n' +
                '\n' +
                '        # Cetak konten asli ke stdout agar bisa ditangkap oleh program lain\n' +
                '        print(original_content)\n' +
                '\n' +
                '    except FileNotFoundError:\n' +
                '        print(f"ERROR: File terenkripsi tidak ditemukan: {encrypted_file_path}", file=sys.stderr)\n' +
                '        sys.exit(1)\n' +
                '    except Exception as e:\n' +
                '        print(f"ERROR: Kesalahan saat membaca atau mendekode file terenkripsi: {e}", file=sys.stderr)\n' +
                '        # traceback.print_exc(file=sys.stderr)\n' +
                '        sys.exit(1)\n' +
                '\n' +
                'if __name__ == "__main__":\n' +
                '    main()\n';
            return pythonScript;
        }


        // --- FUNGSI BARU: OBFUSKASI JS MENGGUNAKAN JAVASCRIPT-OBFUSCATOR LIBRARY ---
        async function obfuscateJavaScript(code) {
            if (typeof JavaScriptObfuscator === 'undefined') {
                showToast('Library Javascript Obfuscator belum dimuat. Coba refresh halaman!', 'error');
                console.error('JavaScriptObfuscator is not defined.');
                return null;
            }

            const options = {
                compact: compactCode.checked,
                controlFlowFlattening: controlFlowFlattening.checked,
                controlFlowFlatteningThreshold: parseFloat(controlFlowFlatteningProb.value),
                stringArray: stringArray.checked,
                stringArrayRotate: stringArrayRotate.checked,
                stringArrayEncoding: stringArrayEncoding.value === 'none' ? false : stringArrayEncoding.value, // 'none' means false
                deadCodeInjection: deadCodeInjection.checked,
                deadCodeInjectionThreshold: parseFloat(deadCodeInjectionProb.value),
                identifierNamesGenerator: identifierNamesGenerator.checked ? 'hexadecimal' : 'mangled', // 'hexadecimal' or 'mangled'
                unicodeEscapeSequence: unicodeEscapeSequence.value === 'true', // Boolean
                disableConsoleOutput: disableConsoleOutput.checked,
                splitStrings: splitStrings.checked,
                transformObjectKeys: transformObjectKeys.value === 'true', // Boolean
                renameGlobals: renameGlobals.checked,
                selfDefending: selfDefending.checked,
                // Tambahkan opsi lain sesuai kebutuhan dari dokumentasi library
                numbersToExpressions: true, // Mengubah angka menjadi ekspresi (0x1 -> !+[]-~[])
                simplifyProperties: true, // Menyederhanakan akses properti
                rotateStringArray: true, // Memutar array string
                debugProtection: false, // Jangan diaktifkan kalau nggak mau pusing nge-debug
                // debugProtectionInterval: false,
                sourceMap: false // Tidak perlu source map untuk obfuscasi penuh
            };

            console.log("Obfuscation Options:", options);

            try {
                const result = await new Promise((resolve, reject) => {
                    // Kasih sedikit delay biar loading message muncul dan JavaScriptObfuscator benar-benar siap
                    setTimeout(() => { 
                        if (typeof JavaScriptObfuscator === 'undefined') {
                            reject(new Error('JavaScriptObfuscator is not defined even after a delay. Ini serius.')); 
                            return;
                        }
                        try {
                            const obfuscatedCode = JavaScriptObfuscator.obfuscate(code, options).get
Code();
                            resolve(obfuscatedCode);
                        } catch (e) {
                            reject(e); // Tangkap error dari obfuscate() itu sendiri
                        }
                    }, 50); 
                });
                return result;
            } catch (e) {
                console.error("Error during JavaScript obfuscation:", e);
                showToast(`Gagal obfuscate JavaScript: ${e.message}`, 'error');
                return null;
            }
        }


        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; 
            
            console.log("File dipilih:", file);

            if (file) {
                const reader = new FileReader();

                currentFileName = file.name;
                const lastDotIndex = file.name.lastIndexOf('.');
                if (lastDotIndex > 0) {
                    currentFileExtension = file.name.substring(lastDotIndex).toLowerCase();
                } else {
                    currentFileExtension = ''; 
                }
                
                fileNameSpan.textContent = file.name;
                fileSizeSpan.textContent = `${(file.size / 1024).toFixed(2)} KB`;
                fileInfoDiv.classList.remove('hidden');

                showLoading('Membaca file...');
                
                reader.onload = (e) => {
                    const content = e.target.result;
                    originalContentArea.value = content; 
                    originalFileChecksum = simpleHash(content); 
                    hideLoading();
                    showToast('File berhasil dibaca dan checksum dihitung!', 'success');
                    encodedOutput.value = ''; 
                    currentEncodedMarvelString = ''; 
                    hideMessage(licenseErrorDiv);
                    updateButtonStates(); 
                };

                reader.onerror = (e) => {
                    hideLoading();
                    console.error('Error saat membaca file:', e); 
                    originalContentArea.value = 'Gagal membaca file, bro. Coba lagi deh.';
                    originalFileChecksum = '';
                    showToast('Gagal membaca file!', 'error');
                    encodedOutput.value = '';
                    currentEncodedMarvelString = ''; 
                    hideMessage(licenseErrorDiv);
                    hideMessage(executionWarningMessage);
                    hideMessage(obfuscationWarningMessage);
                    updateButtonStates();
                };

                reader.readAsText(file); 
            } else {
                fileInfoDiv.classList.add('hidden');
                originalContentArea.value = '';
                encodedOutput.value = '';
                currentFileName = '';
                currentFileExtension = '';
                originalFileChecksum = '';
                currentEncodedMarvelString = ''; 
                hideMessage(licenseErrorDiv);
                hideMessage(executionWarningMessage);
                hideMessage(obfuscationWarningMessage);
                updateButtonStates();
                console.log("Tidak ada file yang dipilih.");
            }
        });

        licenseKeyInput.addEventListener('input', updateButtonStates);
        originalContentArea.addEventListener('input', updateButtonStates); 
        
        // Event listeners for expiration options
        expireSpecificDateRadio.addEventListener('change', updateButtonStates);
        specificDateInput.addEventListener('change', updateButtonStates);
        expireRelativeRadio.addEventListener('change', updateButtonStates);
        relativeDurationInput.addEventListener('input', updateButtonStates);
        relativeUnitSelect.addEventListener('change', updateButtonStates);
        expireNeverRadio.addEventListener('change', updateButtonStates);

        // Event listeners for obfuscation options (re-check button states)
        document.querySelectorAll('.obfuscation-option input, .obfuscation-option select').forEach(element => {
            element.addEventListener('change', updateButtonStates);
        });


        encodeButton.addEventListener('click', async () => { 
            const licenseKey = licenseKeyInput.value.trim(); 
            let fileContent = originalContentArea.value; // Bisa di-obfuscate dulu jika JS

            if (!fileContent) {
                showToast('Bro, upload file dulu dong atau paste isinya!', 'warning');
                return;
            }

            if (!licenseKey) {
                showMessage(licenseErrorDiv, "License Key harus diisi!", "error");
                showToast('License Key kosong, bre!', 'error');
                return;
            }

            const calculatedExpireDateStr = calculateExpiryDate();
            if (!calculatedExpireDateStr && !expireNeverRadio.checked) {
                showMessage(licenseErrorDiv, "Pilih atau masukkan tanggal kedaluwarsa yang valid!", "error");
                showToast('Tanggal kedaluwarsa belum diatur dengan benar!', 'error');
                return;
            }

            hideMessage(licenseErrorDiv); 
            hideMessage(infoMessage); // Hide info message if re-encoding

            showLoading('Mengecek proteksi dan meng-encode...');

            const { isValid, errors } = checkProtectionStatus(licenseKey, originalFileChecksum, calculatedExpireDateStr);

            if (!isValid) {
                hideLoading();
                let errorMessage = "Gagal memproses karena masalah proteksi:\\n\\n";
                errors.forEach(err => {
                    errorMessage += "- " + err + "\\n";
                    if (err.includes("expired")) alert("WADUH! LICENSE SUDAH EXPIRED!");
                });
                showMessage(licenseErrorDiv, errorMessage, "error");
                encodedOutput.value = "Error: Proteksi Gagal! Lihat pesan di atas.";
                showToast('Proteksi gagal, bro!', 'error');
                updateButtonStates();
                return;
            }

            if (errors.length > 0) {
                 let warningMessage = "Peringatan:\\n\\n";
                 errors.forEach(err => {
                    if (err.includes("Checksum tidak cocok")) {
                         warningMessage += "- " + err + "\\n";
                    }
                 });
                 if (warningMessage !== "Peringatan:\\n\\n") {
                     showMessage(licenseErrorDiv, warningMessage, "warning");
                 }
            }

            // Jika file JS, lakukan obfuscation dulu sebelum encode
            if (currentFileExtension === '.js') {
                showLoading('Meng-obfuscate JavaScript...');
                const obfuscatedJs = await obfuscateJavaScript(fileContent);
                if (obfuscatedJs) {
                    fileContent = obfuscatedJs; // Gunakan kode JS yang sudah di-obfuscate
                    showToast('JavaScript berhasil di-obfuscate!', 'success');
                } else {
                    hideLoading();
                    showToast('Gagal obfuscate JavaScript, proses proteksi dibatalkan.', 'error');
                    return;
                }
            }


            try {
                const encoded = encodeFileContent(fileContent);
                encodedOutput.value = encoded;
                currentEncodedMarvelString = encoded; 
                hideLoading();
                showToast('File berhasil di-encode dan proteksi lolos!', 'success');
            } catch (error) {
                hideLoading();
                console.error('Error saat encoding:', error);
                encodedOutput.value = 'Waduh, ada error saat encoding: ' + error.message;
                showToast('Gagal encode file, bro!', 'error');
            } finally {
                updateButtonStates();
            }
        });

        // New Button: Obfuscate JS Saja
        obfuscateJsButton.addEventListener('click', async () => {
            const fileContent = originalContentArea.value;

            if (!fileContent || currentFileExtension !== '.js') {
                showToast('Pilih file JavaScript (.js) dulu, bro!', 'warning');
                return;
            }

            showLoading('Meng-obfuscate JavaScript saja...');
            const obfuscatedJs = await obfuscateJavaScript(fileContent);

            if (obfuscatedJs) {
                encodedOutput.value = obfuscatedJs;
                currentEncodedMarvelString = ''; // Reset karena ini hanya obfuscate, bukan encode proteksi
                hideLoading();
                showToast('JavaScript berhasil di-obfuscate saja!', 'success');
            } else {
                encodedOutput.value = 'Gagal obfuscate JavaScript.';
                hideLoading();
                showToast('Gagal obfuscate JavaScript!', 'error');
            }
            updateButtonStates();
        });


        copyOutputButton.addEventListener('click', () => {
            if (!encodedOutput.value) {
                showToast('Belum ada hasil yang bisa disalin, bre!', 'warning');
                return;
            }
            encodedOutput.select();
            encodedOutput.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(encodedOutput.value)
                    .then(() => showToast('Hasil udah disalin ke clipboard, mantap!', 'success'))
                    .catch(err => {
                        console.error('Gagal menyalin teks:', err);
                        showToast('Gagal nyalin teks. Browser lo kayaknya gak support Clipboard API nih.', 'error');
                    });
            } catch (err) {
                console.error('Browser tidak support Clipboard API:', err);
                document.execCommand('copy');
                showToast('Hasil udah disalin (metode lama), bro!', 'success');
            }
        });

        // Removed saveOutputButton logic, it's now integrated into generateScriptButton or can be manually copied.

        generateScriptButton.addEventListener('click', async () => { // Make it async
            if (!currentEncodedMarvelString) {
                showToast('Encode dulu filenya, bro, baru bisa generate script!', 'warning');
                return;
            }

            const customLicenseKey = licenseKeyInput.value.trim(); 
            const finalExpireDateStr = calculateExpiryDate();

            if (!finalExpireDateStr && !expireNeverRadio.checked) {
                showToast('Pilih atau masukkan tanggal kedaluwarsa yang valid sebelum generate script!', 'error');
                return;
            }

            showLoading('Menciptakan file-file proteksi...');
            
            // 1. Generate Python Validator Script
            const pythonValidatorContent = generatePythonValidatorScript(customLicenseKey, finalExpireDateStr);
            const pythonBlob = new Blob([pythonValidatorContent], { type: 'text/plain;charset=utf-8' });
            
            const pythonFileName = 'validator.py';
            const aPython = document.createElement('a');
            aPython.href = URL.createObjectURL(pythonBlob);
            aPython.download = pythonFileName;
            document.body.appendChild(aPython);
            aPython.click();
            document.body.removeChild(aPython);
            URL.revokeObjectURL(aPython.href);

            // 2. Generate Encrypted Data File
            // Nama file data terenkripsi akan mengikuti nama asli dengan ekstensi .enc
            let encryptedDataFileName = currentFileName;
            if (encryptedDataFileName.includes('.')) {
                encryptedDataFileName = encryptedDataFileName.substring(0, encryptedDataFileName.lastIndexOf('.')) + '.enc';
            } else {
                encryptedDataFileName += '.enc';
            }

            const encryptedDataBlob = new Blob([currentEncodedMarvelString], { type: 'text/plain;charset=utf-8' });
            const aEncryptedData = document.createElement('a');
            aEncryptedData.href = URL.createObjectURL(encryptedDataBlob);
            aEncryptedData.download = encryptedDataFileName;
            document.body.appendChild(aEncryptedData);
            aEncryptedData.click();
            document.body.removeChild(aEncryptedData);
            URL.revokeObjectURL(aEncryptedData.href);

            hideLoading();
            showToast(`Dua file berhasil di-generate: '${pythonFileName}' dan '${encryptedDataFileName}'!`, 'success');

            // Show instructions to the user
            showMessage(infoMessage, `
                **BERHASIL!** Dua file terproteksi telah diunduh:<br><br>
                1. **\`${pythonFileName}\`**: Ini adalah script Python validator Anda.<br>
                2. **\`${encryptedDataFileName}\`**: Ini adalah file data/kode Anda yang sudah terenkripsi.<br><br>
                **CARA MENGGUNAKAN:**<br>
                Letakkan kedua file ini di folder yang sama dengan aplikasi JavaScript/JSON Anda.<br>
                Kemudian, di script JavaScript Anda (misal: \`app.js\`), Anda perlu memanggil validator Python untuk mendapatkan konten asli:<br><br>
                \`\`\`javascript
                // Contoh penggunaan di Node.js (untuk file JS atau JSON)
                const { execSync } = require('child_process'); // Import untuk menjalankan perintah eksternal
                const fs = require('fs'); // Import untuk membaca/menulis file
                
                const LICENSE_KEY = "${customLicenseKey}"; // Gunakan license key yang sama saat generate
                const ENCRYPTED_FILE = "${encryptedDataFileName}"; // Nama file terenkripsi yang di-generate
                const VALIDATOR_SCRIPT = "${pythonFileName}"; // Nama script validator Python
                
                try {
                    // Jalankan validator Python. Outputnya (stdout) adalah konten yang sudah didekode.
                    // Pastikan Python terinstal di sistem.
                    const decodedContent = execSync(\`python \${VALIDATOR_SCRIPT} \${LICENSE_KEY} \${ENCRYPTED_FILE}\`, { encoding: 'utf8' });
                    
                    // --- PENANGANAN KONTEN ASLI ---
                    if ("${currentFileExtension}" === '.js') {
                        // Jika aslinya JavaScript, jalankan kodenya
                        // HATI-HATI dengan 'eval()', lebih baik disimpan ke file sementara jika memungkinkan
                        // eval(decodedContent); 
                        
                        const tempJsPath = './temp_decoded_app.js';
                        fs.writeFileSync(tempJsPath, decodedContent);
                        require(tempJsPath); // Load JS logic
                        fs.unlinkSync(tempJsPath); // Hapus file sementara
                        console.log("INFO: Skrip JavaScript terproteksi berhasil dijalankan.");

                    } else if ("${currentFileExtension}" === '.json') {
                        // Jika aslinya JSON, parse dan gunakan data
                        const jsonData = JSON.parse(decodedContent);
                        console.log("INFO: Data JSON terproteksi berhasil didekode:", jsonData);
                        // Lakukan sesuatu dengan jsonData Anda
                        
                    } else {
                        // Untuk tipe file lain, atau jika Anda ingin melihat isinya
                        console.log("INFO: Konten terproteksi berhasil didekode:");
                        console.log(decodedContent);
                        // Anda bisa menyimpan decodedContent ke file dengan ekstensi aslinya jika perlu
                        // fs.writeFileSync(\`./decoded_file${currentFileExtension}\`, decodedContent);
                    }

                } catch (error) {
                    console.error('ERROR: Proteksi gagal atau Node.js tidak bisa menjalankan validator Python.');
                    console.error('Pesan dari Validator Python (stderr):', error.stderr ? error.stderr.toString() : 'Tidak ada');
                    console.error('Detail Error:', error.message);
                    process.exit(1); // Hentikan aplikasi jika proteksi gagal
                }
                
                // Lanjutkan kode aplikasi utama Anda di sini setelah konten terproteksi dimuat
                console.log("Aplikasi Anda berjalan setelah proteksi berhasil!");
                \`\`\`
                <br>
                **CATATAN:** User harus memiliki **Python terinstal** di sistem untuk menjalankan validator ini.
            `, "success");
        });


        resetButton.addEventListener('click', () => {
            fileInput.value = '';
            licenseKeyInput.value = '';
            originalContentArea.value = '';
            encodedOutput.value = '';
            fileInfoDiv.classList.add('hidden');
            currentFileName = '';
            currentFileExtension = '';
            originalFileChecksum = '';
            currentEncodedMarvelString = ''; 
            hideMessage(licenseErrorDiv);
            hideMessage(executionWarningMessage); 
            hideMessage(obfuscationWarningMessage); 
            hideMessage(infoMessage); // Hide info message on reset
            specificDateInput.value = ''; 
            relativeDurationInput.value = '1';
            relativeUnitSelect.value = 'days';
            expireSpecificDateRadio.checked = true; 
            
            // Reset obfuscation options to default
            compactCode.checked = true;
            controlFlowFlattening.checked = true;
            controlFlowFlatteningProb.value = '0.7';
            stringArray.checked = true;
            stringArrayRotate.checked = true;
            stringArrayEncoding.value = 'none'; // Default ke none, bisa diubah sesuai preferensi
            deadCodeInjection.checked = false;
            deadCodeInjectionProb.value = '0.5';
            identifierNamesGenerator.checked = true;
            unicodeEscapeSequence.value = 'false';
            disableConsoleOutput.checked = true;
            splitStrings.checked = false;
            transformObjectKeys.value = 'false';
            renameGlobals.checked = true;
            selfDefending.checked = true;

            showToast('Form udah di-reset, siap buat proteksi lagi!', 'info');
            updateButtonStates();
        });

        // Initial state
        updateButtonStates();

        // Set default specific date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        specificDateInput.value = tomorrow.toISOString().split('T')[0];
        updateExpiryDisplay();
    </script>
</body>
</html>
